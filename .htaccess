# Enable URL rewriting
RewriteEngine On
# No RewriteBase needed for subfolder deployment

# Serve all files in /assets/ directory directly (CRITICAL for Vite builds)
RewriteRule ^assets/ - [L]

# Explicitly serve static assets (JS, CSS, images) directly
RewriteCond %{REQUEST_URI} \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|pdf)$ [NC]
RewriteRule ^ - [L]

# Serve static files and directories directly
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Handle client-side routing for React Router
RewriteRule ^ index.html [L]

# MIME types (CRITICAL - Force correct MIME types)
<IfModule mod_mime.c>
    AddType application/javascript .js .mjs
    AddType text/css .css
    AddType image/svg+xml .svg
    AddType image/x-icon .ico
</IfModule>

# Force correct Content-Type header for JS files
<FilesMatch "\.(js|mjs)$">
    <IfModule mod_headers.c>
        Header set Content-Type "application/javascript"
    </IfModule>
</FilesMatch>

# Increase timeout limits
<IfModule mod_fcgid.c>
    FcgidIOTimeout 300
    FcgidConnectTimeout 300
    FcgidBusyTimeout 300
    FcgidIdleTimeout 300
</IfModule>

# Disable gzip ONLY if connection resets persist
# <IfModule mod_deflate.c>
#     SetEnvIfNoCase Request_URI \.js$ no-gzip
# </IfModule>

# COMPLETELY DISABLE compression to prevent connection resets
<IfModule mod_deflate.c>
    # Turn off ALL compression for this directory
    SetEnv no-gzip 1
    
    # Explicitly disable deflate for JavaScript files
    SetEnvIfNoCase Request_URI "\.js$" no-gzip dont-vary
    SetEnvIfNoCase Request_URI "\.css$" no-gzip dont-vary
</IfModule>

# Cache control
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Prevent access to sensitive files
<FilesMatch "\.(htaccess|json|ts|tsx|jsx|env)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Error pages
ErrorDocument 404 index.html